{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "odin intermediate representation",
    "description": "Intermediate representation of odin's equations",

    "definitions": {
        "basic": {
            "character_vector": {
                "type": "array",
                "items": {
                    "type": "string"
                }
            },

            "rank": {
                "type": "integer",
                "minimum": 0,
                "maximum": 8
            }
        },

        "enum": {
            "storage_type": {
                "type": "string",
                "enum": ["double", "int", "interpolate_data"]
            },

            "stage": {
                "type": "string",
                "enum": ["constant", "user", "time", "output"]
            },

            "stage_integer": {
                "comment": "this will be factored out",
                "type": "integer",
                "minimum": 1,
                "maximum": 4
            }
        },

        "sexpression": {
            "comment": "this should be tightened up; the first element must really be an enum of supported functions",
            "oneOf": [
                {
                    "type": "string"
                },
                {
                    "type": "number"
                },
                {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/sexpression"
                    }
                }
            ]
        },

        "config": {
            "type": "object",
            "properties": {
                "base": {
                    "type": "string"
                }
            },
            "required": ["base"],
            "additionalProperties": false
        },

        "features": {
            "type": "object",
            "properties": {
                "discrete": { "type": "boolean" },
                "has_array": { "type": "boolean" },
                "has_output": { "type": "boolean" },
                "has_user": { "type": "boolean" },
                "has_delay": { "type": "boolean" },
                "has_interpolate": { "type": "boolean" },
                "has_stochastic": { "type": "boolean" }
            },
            "required": ["discrete", "has_array", "has_output", "has_user",
                         "has_delay", "has_interpolate", "has_stochastic"],
            "additionalProperties": false
        },

        "data": {
            "type": "object",
            "properties": {
                "internal": { "$ref": "#/definitions/data_internal" },
                "user": {
                    "oneOf": [
                        { "type": "null" },
                        { "$ref": "#/definitions/data_user" }
                    ]
                },
                "initial": { "$ref": "#/definitions/data_initial" },
                "variable": { "$ref": "#/definitions/data_variable" },
                "output": {
                    "oneOf": [
                        { "type": "null" },
                        { "$ref": "#/definitions/data_variable" }
                    ]
                }
            },
            "required": ["internal", "user", "initial", "variable", "output"],
            "additionalProperties": false
        },

        "equations": {
        },

        "components": {
            "type": "object",
            "properties": {
                "create": { "$ref": "#/definitions/component" },
                "user": { "$ref": "#/definitions/component" },
                "initial": { "$ref": "#/definitions/component" },
                "rhs": { "$ref": "#/definitions/component" },
                "output": { "$ref": "#/definitions/component" }
            },
            "required": ["create", "user", "initial", "rhs", "output"],
            "additionalProperties": false
        },

        "component": {
            "type": "object",
            "properties": {
                "variables": { "$ref": "#/definitions/basic/character_vector" },
                "equations": { "$ref": "#/definitions/basic/character_vector" }
            },
            "required": ["variables", "equations"],
            "additionalProperties": false
        },

        "data_internal": {
            "type": "object",
            "properties": {
                "contents": { "$ref": "#/definitions/basic/character_vector" },
                "data": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "stage": {
                                "$ref": "#/definitions/enum/stage_integer"
                            },
                            "storage_type": {
                                "$ref": "#/definitions/enum/storage_type"
                            },
                            "rank": {"$ref": "#/definitions/basic/rank" },
                            "transient": {"type": "boolean"}
                        },
                        "required": ["name", "stage", "storage_type",
                                     "rank", "transient"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["contents", "data"],
            "additionalProperties": false
        },

        "data_user": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {"type": "string"},
                    "rank": {"$ref": "#/definitions/basic/rank" },
                    "default": {"type": "number"}
                },
                "required": ["name", "rank"],
                "additionalProperties": false
            }
        },

        "data_initial": {
            "type": "object",
            "properties": {
                "stage": {
                    "$ref": "#/definitions/enum/stage"
                }
            },
            "required": ["stage"],
            "additionalProperties": false
        },

        "data_variable": {
            "type": "object",
            "properties": {
                "length": {
                    "$ref": "#/definitions/sexpression"
                },
                "length_stage": {
                    "$ref": "#/definitions/enum/stage_integer"
                },
                "data": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "storage_type": {
                                "$ref": "#/definitions/enum/storage_type"
                            },
                            "rank": {
                                "$ref": "#/definitions/basic/rank"
                            },
                            "offset": {
                                "$ref": "#/definitions/sexpression"
                            }
                        },
                        "required": ["name", "storage_type", "rank", "offset"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["length", "length_stage", "data"],
            "additionalProperties": false
        }
    },

    "type": "object",
    "properties": {
        "config": {
            "$ref": "#/definitions/config"
        },
        "features": {
            "$ref": "#/definitions/features"
        },
        "data": {
            "$ref": "#/definitions/data"
        },
        "equations": {
            "$ref": "#/definitions/equations"
        },
        "components": {
            "$ref": "#/definitions/components"
        }
    },
    "required": ["config", "features", "data", "equations", "components"],
    "additionalProperties": false
}
