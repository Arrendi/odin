{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "odin intermediate representation",
    "description": "Intermediate representation of odin's equations",

    "definitions": {
        "basic": {
            "character_vector": {
                "type": "array",
                "items": {
                    "type": "string"
                }
            },

            "integer_vector": {
                "type": "array",
                "items": {
                    "type": "integer"
                }
            },

            "boolean_vector": {
                "type": "array",
                "items": {
                    "type": "boolean"
                }
            },

            "source_reference": {
                "type": "array",
                "items": {
                    "type": "integer",
                    "minimum": 1
                }
            }
        },

        "enum": {
            "storage_type": {
                "type": "string",
                "enum": ["double", "int", "bool", "interpolate_data"]
            },

            "location": {
                "type": "string",
                "enum": ["transient", "internal", "variable", "output"]
            },

            "equation_type": {
                "type": "string",
                "enum": [
                    "alloc",
                    "alloc_interpolate",
                    "copy",
                    "delay_index",
                    "delay_continuous",
                    "user",
                    "expression_array",
                    "expression_scalar"
                ],
                "comment": "This duplicates different equation types"
            },

            "expression_rhs_type": {
                "type": "string",
                "enum": ["atomic", "expression"]
            },

            "interpolate_type": {
                "type": "string",
                "enum": ["constant", "linear", "spline"]
            },

            "stage": {
                "type": "string",
                "enum": ["constant", "user", "time", "output"]
            },

            "index": {
                "type": "string",
                "enum": ["i", "j", "k", "l", "i5", "i6", "i7", "i8"]
            }
        },

        "sexpression": {
            "comment": "this should be tightened up; the first element must really be an enum of supported functions",
            "oneOf": [
                {
                    "type": "string"
                },
                {
                    "type": "number"
                },
                {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/sexpression"
                    }
                }
            ]
        },

        "sexpression_vector": {
            "type": "array",
            "items": {
                "$ref": "#/definitions/sexpression"
            }
        },

        "dependencies": {
            "oneOf": [
                {
                    "type": "null"
                },
                {
                    "type": "object",
                    "properties": {
                        "functions": {
                            "$ref": "#/definitions/basic/character_vector"
                        },
                        "variables": {
                            "$ref": "#/definitions/basic/character_vector"
                        }
                    },
                    "required": ["functions", "variables"],
                    "additionalProperties": false
                }
            ]
        },

        "config": {
            "type": "object",
            "properties": {
                "base": {
                    "type": "string"
                }
            },
            "required": ["base"],
            "additionalProperties": false
        },

        "features": {
            "type": "object",
            "properties": {
                "discrete": { "type": "boolean" },
                "has_array": { "type": "boolean" },
                "has_output": { "type": "boolean" },
                "has_user": { "type": "boolean" },
                "has_delay": { "type": "boolean" },
                "has_interpolate": { "type": "boolean" },
                "has_stochastic": { "type": "boolean" },
                "initial_time_dependent": { "type": "boolean" }
            },
            "required": ["discrete", "has_array", "has_output", "has_user",
                         "has_delay", "has_interpolate", "has_stochastic",
                         "initial_time_dependent"],
            "additionalProperties": false
        },

        "data": {
            "type": "object",
            "properties": {
                "data": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/data_element"
                    }
                },
                "variable": {
                    "$ref": "#/definitions/data_variable"
                },
                "output": {
                    "$ref": "#/definitions/data_output"
                }
            },
            "required": ["data", "variable", "output"],
            "additionalProperties": false
        },

        "data_element": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "location": {
                    "$ref": "#/definitions/enum/location"
                },
                "storage_type": {
                    "$ref": "#/definitions/enum/storage_type"
                },
                "rank": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 8
                },
                "dimnames": {
                    "$ref": "#/definitions/dimnames"
                }
            },
            "required": ["name", "location", "storage_type", "rank",
                         "dimnames"],
            "additionalProperties": false
        },

        "data_variable": {
            "type": "object",
            "properties": {
                "length": {
                    "$ref": "#/definitions/sexpression"
                },
                "contents": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/data_variable_element"
                    }
                }
            },
            "required": ["length", "contents"],
            "additionalProperties": false
        },

        "data_variable_element": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "offset": {
                    "$ref": "#/definitions/sexpression"
                },
                "initial": {
                    "type": "string"
                }
            },
            "required": ["name", "offset", "initial"],
            "additionalProperties": false
        },

        "data_output": {
            "type": "object",
            "comment": "Almost identical to data_variable, but the contents elements do not have an 'initial' property",
            "properties": {
                "length": {
                    "$ref": "#/definitions/sexpression"
                },
                "contents": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/data_output_element"
                    }
                }
            },
            "required": ["length", "contents"],
            "additionalProperties": false
        },

        "data_output_element": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "offset": {
                    "$ref": "#/definitions/sexpression"
                }
            },
            "required": ["name", "offset"],
            "additionalProperties": false
        },

        "equations": {
            "type": "array",
            "items": {
                "$ref": "#/definitions/equation"
            }
        },

        "equation": {
            "allOf": [
                {"$ref": "#/definitions/equation_base"},
                {
                    "oneOf": [
                        {"$ref": "#/definitions/equation_copy"},
                        {"$ref": "#/definitions/equation_alloc"},
                        {"$ref": "#/definitions/equation_alloc_interpolate"},
                        {"$ref": "#/definitions/equation_user"},
                        {"$ref": "#/definitions/equation_expression_array"},
                        {"$ref": "#/definitions/equation_expression_scalar"},
                        {"$ref": "#/definitions/equation_delay_index"},
                        {"$ref": "#/definitions/equation_delay_continuous"}
                    ]
                }
            ]
        },

        "equation_lhs": {
            "type": "object",
            "properties": {
                "target": {
                    "type": "string"
                }
            },
            "required": ["target"],
            "additionalProperties": false
        },

        "equation_rhs_scalar": {
            "type": "object",
            "properties": {
                "type": {
                    "$ref": "#/definitions/enum/expression_rhs_type"
                },
                "value": {
                    "$ref": "#/definitions/sexpression"
                }
            },
            "required": ["type", "value"],
            "additionalProperties": false
        },

        "equation_rhs_array": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "type": {
                        "$ref": "#/definitions/enum/expression_rhs_type"
                    },
                    "value": {
                        "$ref": "#/definitions/sexpression"
                    },
                    "index": {
                        "type": "array",
                        "items": {
                            "$ref": "#/definitions/equation_rhs_array_index"
                        }
                    }
                },
                "required": ["type", "value", "index"],
                "additionalProperties": false
            },
            "minItems": 1
        },

        "equation_rhs_array_index": {
            "type": "object",
            "properties": {
                "value": {
                    "$ref": "#/definitions/sexpression"
                },
                "is_range": {
                    "type": "boolean"
                },
                "index": {
                    "$ref": "#/definitions/enum/index"
                }
            },
            "required": ["value", "is_range", "index"],
            "additionalProperties": false
        },

        "equation_base": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "type": {
                    "$ref": "#/definitions/enum/equation_type"
                },
                "source": {
                    "$ref": "#/definitions/basic/source_reference"
                },
                "depends": {
                    "$ref": "#/definitions/dependencies"
                },
                "lhs": {
                    "$ref": "#/definitions/equation_lhs"
                }
            },
            "required": ["name", "type", "source", "depends", "lhs"]
        },

        "equation_alloc": {
            "type": "object",
            "properties": {
                "type": {"const": "alloc"},
                "name": {},
                "source": {},
                "depends": {},
                "lhs": {}
            },
            "required": ["type"],
            "additionalProperties": false
        },

        "equation_delay_index": {
            "type": "object",
            "properties": {
                "type": {"const": "delay_index"},
                "name": {},
                "source": {},
                "depends": {},
                "lhs": {},
                "delay": {}
            },
            "required": ["type", "delay"],
            "additionalProperties": false
        },

        "equation_copy": {
            "type": "object",
            "properties": {
                "type": {"const": "copy"},
                "name": {},
                "source": {},
                "depends": {},
                "lhs": {}
            },
            "required": ["type"],
            "additionalProperties": false
        },

        "equation_expression_scalar": {
            "type": "object",
            "properties": {
                "type": {"const": "expression_scalar"},
                "name": {},
                "source": {},
                "depends": {},
                "lhs": {},
                "rhs": {
                    "$ref": "#/definitions/equation_rhs_scalar"
                }
            },
            "required": ["type", "rhs"],
            "additionalProperties": false
        },

        "equation_expression_array": {
            "type": "object",
            "properties": {
                "type": {"const": "expression_array"},
                "name": {},
                "source": {},
                "depends": {},
                "lhs": {},
                "rhs": {"$ref": "#/definitions/equation_rhs_array"}
            },
            "required": ["type", "rhs"],
            "additionalProperties": false
        },

        "equation_alloc_interpolate": {
            "type": "object",
            "properties": {
                "type": {"const": "alloc_interpolate"},
                "name": {},
                "source": {},
                "depends": {},
                "lhs": {},
                "interpolate": {
                    "type": "object",
                    "properties": {
                        "t": {
                            "type": "string"
                        },
                        "y": {
                            "type": "string"
                        },
                        "type": {
                            "$ref": "#/definitions/enum/interpolate_type"
                        }
                    },
                    "required": ["t", "y", "type"],
                    "additionalProperties": false
                }
            },
            "required": ["type", "interpolate"],
            "additionalProperties": false
        },

        "equation_user": {
            "type": "object",
            "properties": {
                "type": {"const": "user"},
                "name": {},
                "source": {},
                "depends": {},
                "lhs": {},
                "user": {
                    "type": "object",
                    "properties": {
                        "default": {
                            "oneOf": [
                                {"type": "null"},
                                {"type": "number"}
                            ]
                        },
                        "dim": {"type": "boolean"}
                    },
                    "required": ["default", "dim"],
                    "additionalProperties": false
                }
            },
            "required": ["type", "user"],
            "additionalProperties": false
        },

        "equation_delay_continuous": {
            "type": "object",
            "properties": {
                "type": {"const": "delay_continuous"},
                "name": {},
                "source": {},
                "depends": {},
                "lhs": {},
                "rhs": {},
                "delay": {}
            },
            "required": ["type", "rhs"],
            "additionalProperties": false
        },

        "components": {
            "type": "object",
            "properties": {
                "create": { "$ref": "#/definitions/component" },
                "user": { "$ref": "#/definitions/component" },
                "initial": { "$ref": "#/definitions/component" },
                "rhs": { "$ref": "#/definitions/component" },
                "output": { "$ref": "#/definitions/component" }
            },
            "required": ["create", "user", "initial", "rhs", "output"],
            "additionalProperties": false
        },

        "component": {
            "type": "object",
            "properties": {
                "variables": {
                    "$ref": "#/definitions/basic/character_vector"
                },
                "equations": {
                    "$ref": "#/definitions/basic/character_vector"
                }
            },
            "required": ["variables", "equations"],
            "additionalProperties": false
        },

        "user": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {
                        "type": "string"
                    },
                    "has_default": {
                        "type": "boolean"
                    }
                },
                "required": ["name", "has_default"],
                "additionalProperties": false
            }
        },

        "dimnames": {
            "oneOf": [
                {"type": "null"},
                {"$ref": "#/definitions/dimnames_used"}
            ]
        },

        "dimnames_used": {
            "type": "object",
            "properties": {
                "length": {
                    "type": "string"
                },
                "dim": {
                    "oneOf": [
                        {"$ref": "#/definitions/basic/character_vector"},
                        {"type": "null"}
                    ]
                },
                "mult": {
                    "oneOf": [
                        {"$ref": "#/definitions/basic/character_vector"},
                        {"type": "null"}
                    ]
                }
            },
            "required": ["length", "dim", "mult"],
            "additionalProperties": false
        },

        "interpolate": {
            "type": "object",
            "properties": {
                "min": {
                    "$ref": "#/definitions/basic/character_vector"
                },
                "max": {
                    "$ref": "#/definitions/basic/character_vector"
                },
                "critical": {
                    "$ref": "#/definitions/basic/character_vector"
                }
            },
            "required": ["min", "max", "critical"],
            "additionalProperties": false
        }
    },

    "type": "object",
    "properties": {
        "config": {
            "$ref": "#/definitions/config"
        },
        "features": {
            "$ref": "#/definitions/features"
        },
        "data": {
            "$ref": "#/definitions/data"
        },
        "equations": {
            "$ref": "#/definitions/equations"
        },
        "components": {
            "$ref": "#/definitions/components"
        },
        "user": {
            "$ref": "#/definitions/user"
        },
        "delay": {
        },
        "interpolate": {
            "$ref": "#/definitions/interpolate"
        },
        "source": {
            "$ref": "#/definitions/basic/character_vector"
        }
    },
    "required": ["config", "features", "data", "equations", "components",
                 "user", "interpolate", "source"],
    "additionalProperties": false
}
