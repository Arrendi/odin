{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "odin intermediate representation",
    "description": "Intermediate representation of odin's equations",

    "definitions": {
        "basic": {
            "character_vector": {
                "type": "array",
                "items": {
                    "type": "string"
                }
            },

            "integer_vector": {
                "type": "array",
                "items": {
                    "type": "integer"
                }
            },

            "rank": {
                "type": "integer",
                "minimum": 0,
                "maximum": 8
            },

            "source_reference": {
                "type": "array",
                "items": {
                    "type": "integer",
                    "minimum": 0
                }
            }
        },

        "enum": {
            "storage_type": {
                "type": "string",
                "enum": ["double", "int", "interpolate_data"]
            },

            "location": {
                "type": "string",
                "enum": ["internal", "variable", "output"]
            },

            "equation_type": {
                "type": "string",
                "enum": [
                    "array_expression",
                    "copy",
                    "dim",
                    "interpolate",
                    "scalar_expression",
                    "user",
                    "null"
                ],
                "comment": "This duplicates different equation types"
            },

            "stage": {
                "type": "string",
                "enum": ["constant", "user", "time", "output"]
            },

            "stage_integer": {
                "comment": "this will be factored out",
                "type": "integer",
                "minimum": 1,
                "maximum": 4
            }
        },

        "sexpression": {
            "comment": "this should be tightened up; the first element must really be an enum of supported functions",
            "oneOf": [
                {
                    "type": "string"
                },
                {
                    "type": "number"
                },
                {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/sexpression"
                    }
                }
            ]
        },

        "config": {
            "type": "object",
            "properties": {
                "base": {
                    "type": "string"
                }
            },
            "required": ["base"],
            "additionalProperties": false
        },

        "features": {
            "type": "object",
            "properties": {
                "discrete": { "type": "boolean" },
                "has_array": { "type": "boolean" },
                "has_output": { "type": "boolean" },
                "has_user": { "type": "boolean" },
                "has_delay": { "type": "boolean" },
                "has_interpolate": { "type": "boolean" },
                "has_stochastic": { "type": "boolean" }
            },
            "required": ["discrete", "has_array", "has_output", "has_user",
                         "has_delay", "has_interpolate", "has_stochastic"],
            "additionalProperties": false
        },

        "data": {
            "type": "object",
            "properties": {
                "internal": { "$ref": "#/definitions/data_internal" },
                "user": {
                    "oneOf": [
                        { "type": "null" },
                        { "$ref": "#/definitions/data_user" }
                    ]
                },
                "initial": { "$ref": "#/definitions/data_initial" },
                "variable": { "$ref": "#/definitions/data_variable" },
                "output": {
                    "oneOf": [
                        { "type": "null" },
                        { "$ref": "#/definitions/data_variable" }
                    ]
                }
            },
            "required": ["internal", "user", "initial", "variable", "output"],
            "additionalProperties": false
        },

        "equations": {
            "type": "array",
            "items": {
                "$ref": "#/definitions/equation"
            }
        },

        "equation": {
            "allOf": [
                {"$ref": "#/definitions/equation_base"},
                {
                    "oneOf": [
                        {"$ref": "#/definitions/equation_dim"},
                        {"$ref": "#/definitions/equation_copy"},
                        {"$ref": "#/definitions/equation_array_expression"},
                        {"$ref": "#/definitions/equation_scalar_expression"},
                        {"$ref": "#/definitions/equation_interpolate"},
                        {"$ref": "#/definitions/equation_user"},
                        {"$ref": "#/definitions/equation_user"}
                    ]
                }
            ]
        },

        "equation_base": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"$ref": "#/definitions/enum/equation_type"},
                "source": {"$ref": "#/definitions/basic/source_reference"},
                "depends": {}
            },
            "required": ["name", "type", "source", "depends"]
        },

        "equation_copy": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "copy"},
                "source": {},
                "depends": {},
                "stochastic": {"const": false},
                "lhs": {"type": "object"},
                "rhs": {"type": "object"}
            },
            "required": ["name", "type", "stochastic", "lhs", "rhs"],
            "additionalProperties": false
        },

        "equation_dim": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "dim"},
                "source": {},
                "depends": {},
                "stochastic": {"const": false},
                "lhs": {"type": "object"},
                "rhs": {"type": "object"}
            },
            "required": ["name", "type", "stochastic",
                         "lhs", "rhs"],
            "additionalProperties": false
        },

        "equation_scalar_expression": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "scalar_expression"},
                "source": {},
                "depends": {},
                "stochastic": {"type": "boolean"},
                "lhs": {
                    "type": "object",
                    "properties": {
                        "location": {"$ref": "#/definitions/enum/location"},
                        "target": {"type": "string"}
                    },
                    "required": ["location", "target"],
                    "additionalProperties": false
                },
                "rhs": {
                    "type": "object",
                    "properties": {
                        "type": {"type": "string"},
                        "value": {"$ref": "#/definitions/sexpression"}
                    },
                    "required": ["type", "value"],
                    "additionalProperties": false
                }
            },
            "required": ["name", "type", "stochastic", "lhs", "rhs"],
            "additionalProperties": false
        },

        "equation_array_expression": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "array_expression"},
                "source": {},
                "depends": {},
                "stochastic": {"type": "boolean"},
                "lhs": {"type": "object"},
                "rhs": {"type": "object"}
            },
            "required": ["name", "type", "stochastic", "lhs", "rhs"],
            "additionalProperties": false
        },

        "equation_interpolate": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "interpolate"},
                "source": {},
                "depends": {},
                "stochastic": {"const": false},
                "lhs": {"type": "object"},
                "rhs": {"type": "object"}
            },
            "required": ["name", "type", "stochastic", "lhs", "rhs"],
            "additionalProperties": false
        },

        "equation_user": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "user"},
                "source": {},
                "depends": {},
                "stochastic": {"const": false},
                "lhs": {
                    "TODO": "this is the same as equation_scalar_expression",
                    "type": "object",
                    "properties": {
                        "location": {"$ref": "#/definitions/enum/location"},
                        "target": {"type": "string"}
                    },
                    "required": ["location", "target"],
                    "additionalProperties": false
                },
                "rhs": {
                    "type": "object",
                    "TODO": "this needs tidying up a little",
                    "properties": {
                        "type": {"const": "expression"},
                        "value": {
                            "oneOf": [
                                {"type": "null"},
                                {"type": "number"}
                            ]
                        }
                    },
                    "required": ["type", "value"],
                    "additionalProperties": false
                }
            },
            "required": ["name", "type", "lhs", "rhs"],
            "additionalProperties": false
        },

        "equation_null": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "null"},
                "source": {},
                "depends": {"type": "null"},
                "stochastic": {"const": false},
                "lhs": {"type": "object"},
                "rhs": {"type": "object"}
            },
            "required": ["name", "type", "stochastic", "lhs", "rhs"],
            "additionalProperties": false
        },

        "components": {
            "type": "object",
            "properties": {
                "create": { "$ref": "#/definitions/component" },
                "user": { "$ref": "#/definitions/component" },
                "initial": { "$ref": "#/definitions/component" },
                "rhs": { "$ref": "#/definitions/component" },
                "output": { "$ref": "#/definitions/component" }
            },
            "required": ["create", "user", "initial", "rhs", "output"],
            "additionalProperties": false
        },

        "component": {
            "type": "object",
            "properties": {
                "variables": { "$ref": "#/definitions/basic/character_vector" },
                "equations": { "$ref": "#/definitions/basic/character_vector" }
            },
            "required": ["variables", "equations"],
            "additionalProperties": false
        },

        "data_internal": {
            "type": "object",
            "properties": {
                "contents": { "$ref": "#/definitions/basic/character_vector" },
                "data": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "storage_type": {
                                "$ref": "#/definitions/enum/storage_type"
                            },
                            "rank": {"$ref": "#/definitions/basic/rank" },
                            "user": {
                                "comment": "subject to change",
                                "type": "boolean"
                            },
                            "transient": {"type": "boolean"}
                        },
                        "required": ["name", "storage_type", "rank",
                                     "user", "transient"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["contents", "data"],
            "additionalProperties": false
        },

        "data_user": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {"type": "string"},
                    "rank": {"$ref": "#/definitions/basic/rank" },
                    "has_default": {"type": "boolean"}
                },
                "required": ["name", "rank"],
                "additionalProperties": false
            }
        },

        "data_initial": {
            "type": "object",
            "properties": {
                "stage": {
                    "$ref": "#/definitions/enum/stage"
                }
            },
            "required": ["stage"],
            "additionalProperties": false
        },

        "data_variable": {
            "type": "object",
            "properties": {
                "length": {
                    "$ref": "#/definitions/sexpression"
                },
                "length_stage": {
                    "$ref": "#/definitions/enum/stage_integer"
                },
                "data": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "storage_type": {
                                "$ref": "#/definitions/enum/storage_type"
                            },
                            "rank": {
                                "$ref": "#/definitions/basic/rank"
                            },
                            "offset": {
                                "$ref": "#/definitions/sexpression"
                            }
                        },
                        "required": ["name", "storage_type", "rank", "offset"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["length", "length_stage", "data"],
            "additionalProperties": false
        }
    },

    "type": "object",
    "properties": {
        "config": {
            "$ref": "#/definitions/config"
        },
        "features": {
            "$ref": "#/definitions/features"
        },
        "data": {
            "$ref": "#/definitions/data"
        },
        "equations": {
            "$ref": "#/definitions/equations"
        },
        "components": {
            "$ref": "#/definitions/components"
        },
        "source": {
            "$ref": "#/definitions/basic/character_vector"
        }
    },
    "required": ["config", "features", "data", "equations", "components",
                 "source"],
    "additionalProperties": false
}
