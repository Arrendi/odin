{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "odin intermediate representation",
    "description": "Intermediate representation of odin's equations",

    "definitions": {
        "basic": {
            "character_vector": {
                "type": "array",
                "items": {
                    "type": "string"
                }
            },

            "integer_vector": {
                "type": "array",
                "items": {
                    "type": "integer"
                }
            },

            "boolean_vector": {
                "type": "array",
                "items": {
                    "type": "boolean"
                }
            },

            "rank": {
                "type": "integer",
                "minimum": 0,
                "maximum": 8
            },

            "source_reference": {
                "type": "array",
                "items": {
                    "type": "integer",
                    "minimum": 0
                }
            }
        },

        "enum": {
            "storage_type": {
                "type": "string",
                "enum": ["double", "int", "interpolate_data"]
            },

            "location": {
                "type": "string",
                "enum": ["internal", "variable", "output"]
            },

            "equation_type": {
                "type": "string",
                "enum": [
                    "alloc",
                    "alloc_interpolate",
                    "copy",
                    "user",
                    "expression_array",
                    "expression_scalar"
                ],
                "comment": "This duplicates different equation types"
            },

            "interpolation_type": {
                "type": "string",
                "enum": ["constant", "linear", "spline"]
            },

            "stage": {
                "type": "string",
                "enum": ["constant", "user", "time", "output"]
            }
        },

        "sexpression": {
            "comment": "this should be tightened up; the first element must really be an enum of supported functions",
            "oneOf": [
                {
                    "type": "string"
                },
                {
                    "type": "number"
                },
                {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/sexpression"
                    }
                }
            ]
        },

        "sexpression_vector": {
            "type": "array",
            "items": {
                "$ref": "#/definitions/sexpression"
            }
        },

        "sexpression_vector_null": {
            "type": "array",
            "TODO": "this is here until I think more carefully about extent_min",
            "items": {
                "oneOf": [
                    {"$ref": "#/definitions/sexpression"},
                    {"type": "null"}
                ]
            }
        },

        "dependencies": {
            "oneOf": [
                {"type": "null"},
                {
                    "type": "object",
                    "properties": {
                        "functions": {
                            "$ref": "#/definitions/basic/character_vector"
                        },
                        "variables": {
                            "$ref": "#/definitions/basic/character_vector"
                        }
                    },
                    "required": ["functions", "variables"],
                    "additionalProperties": false
                }
            ]
        },

        "config": {
            "type": "object",
            "properties": {
                "base": {
                    "type": "string"
                }
            },
            "required": ["base"],
            "additionalProperties": false
        },

        "features": {
            "type": "object",
            "properties": {
                "discrete": { "type": "boolean" },
                "has_array": { "type": "boolean" },
                "has_output": { "type": "boolean" },
                "has_user": { "type": "boolean" },
                "has_delay": { "type": "boolean" },
                "has_interpolate": { "type": "boolean" },
                "has_stochastic": { "type": "boolean" }
            },
            "required": ["discrete", "has_array", "has_output", "has_user",
                         "has_delay", "has_interpolate", "has_stochastic"],
            "additionalProperties": false
        },

        "data": {
            "type": "object",
            "properties": {
                "internal": {
                    "$ref": "#/definitions/data_internal"
                },
                "initial": {
                    "$ref": "#/definitions/data_initial"
                },
                "variable": {
                    "$ref": "#/definitions/data_variable"
                },
                "output": {
                    "oneOf": [
                        { "type": "null" },
                        { "$ref": "#/definitions/data_variable" }
                    ]
                }
            },
            "required": ["internal", "initial", "variable", "output"],
            "additionalProperties": false
        },

        "equations": {
            "type": "array",
            "items": {
                "$ref": "#/definitions/equation"
            }
        },

        "equation": {
            "allOf": [
                {"$ref": "#/definitions/equation_base"},
                {
                    "oneOf": [
                        {"$ref": "#/definitions/equation_copy"},
                        {"$ref": "#/definitions/equation_alloc"},
                        {"$ref": "#/definitions/equation_alloc_interpolate"},
                        {"$ref": "#/definitions/equation_user"},
                        {"$ref": "#/definitions/equation_expression_array"},
                        {"$ref": "#/definitions/equation_expression_scalar"}
                    ]
                }
            ]
        },

        "equation_lhs_simple": {
            "comment": "this could do with a better name!",
            "type": "object",
            "properties": {
                "location": {"$ref": "#/definitions/enum/location"},
                "target": {"type": "string"}
            },
            "required": ["location", "target"],
            "additionalProperties": false
        },

        "equation_lhs_array": {
            "type": "object",
            "properties": {
                "location": {"$ref": "#/definitions/enum/location"},
                "target": {"type": "string"},
                "index": {
                    "comment": "this is a complex object: first index is equation, second is dimension",
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "value": {
                                "$ref": "#/definitions/sexpression_vector"
                            },
                            "is_range": {
                                "$ref": "#/definitions/basic/boolean_vector"
                            },
                            "extent_min": {
                                "$ref": "#/definitions/sexpression_vector_null"
                            },
                            "extent_max": {
                                "$ref": "#/definitions/sexpression_vector"
                            }
                        },
                        "required": ["value", "is_range",
                                     "extent_min", "extent_max"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["location", "target", "index"],
            "additionalProperties": false
        },

        "equation_base": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"$ref": "#/definitions/enum/equation_type"},
                "source": {"$ref": "#/definitions/basic/source_reference"},
                "depends": {"$ref": "#/definitions/dependencies"}
            },
            "required": ["name", "type", "source", "depends"]
        },

        "equation_alloc": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "alloc"},
                "source": {},
                "depends": {},
                "lhs": {
                    "$ref": "#/definitions/equation_lhs_simple"
                }
            },
            "required": ["name", "type", "lhs"],
            "additionalProperties": false
        },

        "equation_copy": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "copy"},
                "source": {},
                "depends": {},
                "lhs": {
                    "$ref": "#/definitions/equation_lhs_simple"
                }
            },
            "required": ["name", "type", "lhs"],
            "additionalProperties": false
        },

        "equation_expression_scalar": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "expression_scalar"},
                "source": {},
                "depends": {},
                "stochastic": {"type": "boolean"},
                "lhs": {
                    "$ref": "#/definitions/equation_lhs_simple"
                },
                "rhs": {
                    "type": "object",
                    "properties": {
                        "type": {"type": "string"},
                        "value": {"$ref": "#/definitions/sexpression"}
                    },
                    "required": ["type", "value"],
                    "additionalProperties": false
                }
            },
            "required": ["name", "type", "stochastic", "lhs", "rhs"],
            "additionalProperties": false
        },

        "equation_expression_array": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "expression_array"},
                "source": {},
                "depends": {},
                "stochastic": {"type": "boolean"},
                "lhs": {"$ref": "#/definitions/equation_lhs_array"},
                "rhs": {"type": "object"}
            },
            "required": ["name", "type", "stochastic", "lhs", "rhs"],
            "additionalProperties": false
        },

        "equation_alloc_interpolate": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "alloc_interpolate"},
                "source": {},
                "depends": {},
                "lhs": {
                    "$ref": "#/definitions/equation_lhs_simple"
                },
                "interpolate": {
                    "type": "object",
                    "properties": {
                        "t": {"type": "string"},
                        "y": {"type": "string"},
                        "type": {
                            "$ref": "#/definitions/enum/interpolation_type"
                        }
                    },
                    "required": ["t", "y", "type"],
                    "additionalProperties": false
                }
            },
            "required": ["name", "type", "lhs", "interpolate"],
            "additionalProperties": false
        },

        "equation_user": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "type": {"const": "user"},
                "source": {},
                "depends": {},
                "lhs": {
                    "$ref": "#/definitions/equation_lhs_simple"
                },
                "user": {
                    "type": "object",
                    "properties": {
                        "default": {
                            "oneOf": [
                                {"type": "null"},
                                {"type": "number"}
                            ]
                        },
                        "dim": {"type": "boolean"}
                    },
                    "required": ["default", "dim"],
                    "additionalProperties": false
                }
            },
            "required": ["name", "type", "lhs", "user"],
            "additionalProperties": false
        },

        "components": {
            "type": "object",
            "properties": {
                "create": { "$ref": "#/definitions/component" },
                "user": { "$ref": "#/definitions/component" },
                "initial": { "$ref": "#/definitions/component" },
                "rhs": { "$ref": "#/definitions/component" },
                "output": { "$ref": "#/definitions/component" }
            },
            "required": ["create", "user", "initial", "rhs", "output"],
            "additionalProperties": false
        },

        "component": {
            "type": "object",
            "properties": {
                "variables": { "$ref": "#/definitions/basic/character_vector" },
                "equations": { "$ref": "#/definitions/basic/character_vector" }
            },
            "required": ["variables", "equations"],
            "additionalProperties": false
        },

        "data_internal": {
            "type": "object",
            "properties": {
                "contents": { "$ref": "#/definitions/basic/character_vector" },
                "data": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "storage_type": {
                                "$ref": "#/definitions/enum/storage_type"
                            },
                            "rank": {
                                "$ref": "#/definitions/basic/rank"
                            },
                            "dimnames": {
                                "$ref": "#/definitions/dimnames"
                            },
                            "transient": {
                                "type": "boolean"
                            }
                        },
                        "required": ["name", "storage_type", "rank",
                                     "dimnames", "transient"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["contents", "data"],
            "additionalProperties": false
        },

        "data_initial": {
            "type": "object",
            "properties": {
                "stage": {
                    "$ref": "#/definitions/enum/stage"
                }
            },
            "required": ["stage"],
            "additionalProperties": false
        },

        "data_variable": {
            "type": "object",
            "properties": {
                "length": {
                    "$ref": "#/definitions/sexpression"
                },
                "data": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {"type": "string"},
                            "storage_type": {
                                "$ref": "#/definitions/enum/storage_type"
                            },
                            "rank": {
                                "$ref": "#/definitions/basic/rank"
                            },
                            "dimnames": {
                                "$ref": "#/definitions/dimnames"
                            },
                            "offset": {
                                "$ref": "#/definitions/sexpression"
                            }
                        },
                        "required": ["name", "storage_type", "rank", "offset"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["length", "data"],
            "additionalProperties": false
        },

        "user": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "name": {"type": "string"},
                    "has_default": {"type": "boolean"}
                },
                "required": ["name", "has_default"],
                "additionalProperties": false
            }
        },

        "dimnames": {
            "oneOf": [
                {"type": "null"},
                {"$ref": "#/definitions/dimnames_used"}
            ]
        },

        "dimnames_used": {
            "type": "object",
            "properties": {
                "length": {
                    "type": "string"
                },
                "dim": {
                    "oneOf": [
                        {"$ref": "#/definitions/basic/character_vector"},
                        {"type": "null"}
                    ]
                },
                "mult": {
                    "oneOf": [
                        {"$ref": "#/definitions/basic/character_vector"},
                        {"type": "null"}
                    ]
                }
            },
            "required": ["length", "dim", "mult"],
            "additionalProperties": false
        }
    },

    "type": "object",
    "properties": {
        "config": {
            "$ref": "#/definitions/config"
        },
        "features": {
            "$ref": "#/definitions/features"
        },
        "data": {
            "$ref": "#/definitions/data"
        },
        "equations": {
            "$ref": "#/definitions/equations"
        },
        "components": {
            "$ref": "#/definitions/components"
        },
        "user": {
            "$ref": "#/definitions/user"
        },
        "source": {
            "$ref": "#/definitions/basic/character_vector"
        }
    },
    "required": ["config", "features", "data", "equations", "components",
                 "user", "source"],
    "additionalProperties": false
}
